<!DOCTYPE html><html lang="zh-CN" data-astro-cid-37fxchfa> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Olympiad Memoir - Reader</title><!-- 字体 --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,500;1,6..96,400;1,6..96,700&family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet"><!-- Favicon --><link rel="icon" href="https://pic.imgdb.cn/item/65556356c458853aef4ed7e8.png"><style>:root{--bg-color: #000000;--text-primary: #ffffff;--text-secondary: rgba(255, 255, 255, .85)}html{scroll-behavior:auto;overflow-x:hidden}body{margin:0;padding:0;background-color:var(--bg-color);color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;position:relative;min-height:100vh;width:100%;overflow-x:hidden}.light-source[data-astro-cid-37fxchfa]{position:fixed;border-radius:50%;filter:blur(120px);z-index:0;pointer-events:none}.blue-light[data-astro-cid-37fxchfa]{width:40vw;height:40vw;background-color:#00094b;opacity:.9;top:-8vw;right:-8vw;animation:moveBlueLights 8s ease-in-out infinite}.red-light[data-astro-cid-37fxchfa]{width:40vw;height:40vw;background-color:#6d0e11;opacity:.7;mix-blend-mode:screen;top:5vw;right:0vw;animation:moveRedLights 10s ease-in-out infinite}@keyframes moveBlueLights{0%{top:-8vw;right:-8vw}50%{top:-18vw;right:5vw}to{top:-8vw;right:-8vw}}@keyframes moveRedLights{0%{top:5vw;right:0vw}50%{top:-5vw;right:15vw}to{top:5vw;right:0vw}}.brand-nav[data-astro-cid-37fxchfa]{position:fixed;top:40px;right:60px;z-index:2;display:flex;flex-direction:column;align-items:flex-end}.brand[data-astro-cid-37fxchfa]{display:flex;flex-direction:column;align-items:flex-end;margin-bottom:27px}.logo[data-astro-cid-37fxchfa]{height:65px;opacity:.85;transform:translate(14px)}.vertical-nav[data-astro-cid-37fxchfa]{display:flex;flex-direction:column;gap:24px;text-align:right}.nav-item[data-astro-cid-37fxchfa]{text-decoration:none;display:block;transition:all .4s ease}.nav-title[data-astro-cid-37fxchfa] .en[data-astro-cid-37fxchfa]{display:block;font-family:Noto Sans SC,sans-serif;font-size:.85rem;letter-spacing:.2em;color:#ffffff8c;transition:color .3s ease}.nav-title[data-astro-cid-37fxchfa] .zh[data-astro-cid-37fxchfa]{display:block;font-family:Noto Sans SC,sans-serif;font-size:.85rem;letter-spacing:.12rem;margin-top:4px;color:#ffffff59;transition:color .3s ease}.nav-desc[data-astro-cid-37fxchfa]{max-height:0;overflow:hidden;font-size:.75rem;letter-spacing:.05rem;line-height:1.6;color:#fff6;margin-top:0;transition:max-height .4s ease,margin-top .4s ease,opacity .4s ease;opacity:0;white-space:normal;overflow-wrap:anywhere;word-break:break-word;max-width:40ch;hyphens:auto}.nav-item[data-astro-cid-37fxchfa]:hover .nav-desc[data-astro-cid-37fxchfa]{max-height:80px;margin-top:12px;opacity:1}.nav-item[data-astro-cid-37fxchfa]:hover .en[data-astro-cid-37fxchfa]{color:#fff}.nav-item[data-astro-cid-37fxchfa]:hover .zh[data-astro-cid-37fxchfa]{color:#ffffffbf}img[data-astro-cid-37fxchfa]{max-width:100%;height:auto;display:block}.page-content[data-astro-cid-37fxchfa]{position:relative;z-index:1;width:100%}@media(max-width:768px){.brand-nav[data-astro-cid-37fxchfa]{top:20px;right:20px}.logo[data-astro-cid-37fxchfa]{height:55px;transform:translate(8px)}.vertical-nav[data-astro-cid-37fxchfa]{gap:24px}.vertical-nav[data-astro-cid-37fxchfa] .en[data-astro-cid-37fxchfa]{font-size:.9rem}.vertical-nav[data-astro-cid-37fxchfa] .zh[data-astro-cid-37fxchfa]{font-size:.95rem}.nav-desc[data-astro-cid-37fxchfa]{max-width:28ch}}
body{margin:0;overflow:hidden}.reader-container[data-astro-cid-7purwvht]{display:flex;flex-direction:column;height:100vh;width:100vw;background-color:#111;color:#fff;font-family:Noto Sans SC,sans-serif;position:relative;z-index:1000}.brand-nav,.light-source{display:none!important}.reader-header[data-astro-cid-7purwvht]{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:#000c;border-bottom:1px solid rgba(255,255,255,.1);z-index:10;backdrop-filter:blur(10px)}.back-btn[data-astro-cid-7purwvht]{color:#fffc;text-decoration:none;display:flex;align-items:center;gap:.5rem;font-size:1rem;transition:color .3s ease}.back-btn[data-astro-cid-7purwvht]:hover{color:#fff}.reader-controls[data-astro-cid-7purwvht]{display:flex;align-items:center;gap:1rem}.control-btn[data-astro-cid-7purwvht]{background:#ffffff1a;border:1px solid rgba(255,255,255,.2);color:#fff;padding:.5rem 1rem;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .3s ease}.control-btn[data-astro-cid-7purwvht]:hover:not(:disabled){background:#fff3}.control-btn[data-astro-cid-7purwvht]:disabled{opacity:.5;cursor:not-allowed}.icon-btn[data-astro-cid-7purwvht]{padding:.5rem;width:2.5rem;font-size:1.2rem;line-height:1;display:flex;align-items:center;justify-content:center}.page-info[data-astro-cid-7purwvht]{font-family:Noto Sans SC,sans-serif;font-size:1.1rem;min-width:4rem;text-align:center;display:flex;align-items:center;gap:.25rem}.page-input[data-astro-cid-7purwvht]{width:3rem;background:#ffffff1a;border:1px solid rgba(255,255,255,.2);color:#fff;font-family:Noto Sans SC,sans-serif;font-size:1.1rem;text-align:center;padding:.2rem;border-radius:4px;outline:none;transition:border-color .3s ease}.page-input[data-astro-cid-7purwvht]:focus{border-color:#fffc;background:#fff3}.page-input[data-astro-cid-7purwvht]::-webkit-outer-spin-button,.page-input[data-astro-cid-7purwvht]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}.page-input[data-astro-cid-7purwvht][type=number]{-moz-appearance:textfield}.pdf-viewer-wrapper[data-astro-cid-7purwvht]{flex:1;overflow-y:auto;overflow-x:auto;padding:2rem;scrollbar-width:none;-ms-overflow-style:none;position:relative}.pdf-viewer-wrapper[data-astro-cid-7purwvht]::-webkit-scrollbar{display:none}#pdf-container[data-astro-cid-7purwvht]{display:flex;flex-direction:column;align-items:center;gap:2rem;width:100%;margin:0 auto;min-height:100%}.pdf-page[data-astro-cid-7purwvht]{position:relative;box-shadow:0 10px 30px #00000080;background-color:#fff;flex-shrink:0}.pdf-page[data-astro-cid-7purwvht] canvas[data-astro-cid-7purwvht]{display:block;max-width:100%;height:auto!important}.textLayer[data-astro-cid-7purwvht]{position:absolute;inset:0;overflow:hidden;opacity:.2;line-height:1}.textLayer[data-astro-cid-7purwvht]>span[data-astro-cid-7purwvht]{color:transparent;position:absolute;white-space:pre;cursor:text;transform-origin:0% 0%}.textLayer[data-astro-cid-7purwvht] .highlight[data-astro-cid-7purwvht]{margin:-1px;padding:1px;background-color:#b400aa;border-radius:4px}.textLayer[data-astro-cid-7purwvht] .highlight[data-astro-cid-7purwvht].selected{background-color:#006400}.annotationLayer[data-astro-cid-7purwvht]{position:absolute;inset:0;pointer-events:none;z-index:50}.pdf-link[data-astro-cid-7purwvht]{position:absolute;pointer-events:auto;cursor:pointer;z-index:100;border-radius:2px;transition:background-color .2s ease}.pdf-link[data-astro-cid-7purwvht]:hover{background-color:#ff03;box-shadow:0 0 5px #ffff0080}.loading-indicator[data-astro-cid-7purwvht]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2rem;color:#fff9;letter-spacing:.1em}@media(max-width:768px){.reader-header[data-astro-cid-7purwvht]{padding:.8rem 1rem;flex-direction:column;gap:1rem}.back-btn[data-astro-cid-7purwvht]{align-self:flex-start}.reader-controls[data-astro-cid-7purwvht]{width:100%;justify-content:space-between;gap:.5rem}.control-btn[data-astro-cid-7purwvht]{padding:.5rem .8rem;font-size:.9rem}.pdf-viewer-wrapper[data-astro-cid-7purwvht]{padding:1rem;align-items:flex-start}}
</style></head> <body data-astro-cid-37fxchfa> <!-- 光源 --> <div class="light-source blue-light" data-astro-cid-37fxchfa></div> <div class="light-source red-light" data-astro-cid-37fxchfa></div> <!-- 右上角品牌与导航 --> <div class="brand-nav" data-astro-cid-37fxchfa> <div class="brand" data-astro-cid-37fxchfa> <!-- 替换为你的字标图床链接 --> <a href="/" data-astro-cid-37fxchfa> <img src="https://pic1.imgdb.cn/item/6995d39a556e27f1c93a3414.png" alt="字标与徽标" class="logo" data-astro-cid-37fxchfa> </a> </div> <nav class="vertical-nav" data-astro-cid-37fxchfa> <a href="/poetry-prose" class="nav-item" data-astro-cid-37fxchfa> <div class="nav-title" data-astro-cid-37fxchfa> <span class="en" data-astro-cid-37fxchfa>POETRY & PROSE</span> <span class="zh" data-astro-cid-37fxchfa>碘伏诗文</span> </div> <div class="nav-desc" data-astro-cid-37fxchfa>
二两碘酊作为"穑斋主人"的诗文创作空间。<br data-astro-cid-37fxchfa>
记录了他的诗词作品和一些随笔。
</div> </a> <a href="https://www.cnblogs.com/michaelwong007" class="nav-item" data-astro-cid-37fxchfa> <div class="nav-title" data-astro-cid-37fxchfa> <span class="en" data-astro-cid-37fxchfa>PROGRAMMING</span> <span class="zh" data-astro-cid-37fxchfa>程序设计</span> </div> <div class="nav-desc" data-astro-cid-37fxchfa>
二两碘酊关于程序设计的一切。<br data-astro-cid-37fxchfa>
从 OI 到 ACM，从算法到数据结构，<br data-astro-cid-37fxchfa>从学习笔记到授课教案……
</div> </a> <a href="/archive" class="nav-item" data-astro-cid-37fxchfa> <div class="nav-title" data-astro-cid-37fxchfa> <span class="en" data-astro-cid-37fxchfa>ARCHIVE</span> <span class="zh" data-astro-cid-37fxchfa>个人档案</span> </div> <div class="nav-desc" data-astro-cid-37fxchfa>
个人档案馆。<br data-astro-cid-37fxchfa>
关于回忆录，关于创作的视频作品，<br data-astro-cid-37fxchfa>关于二两碘酊的琐碎线索。
</div> </a> <a href="/about" class="nav-item" data-astro-cid-37fxchfa> <div class="nav-title" data-astro-cid-37fxchfa> <span class="en" data-astro-cid-37fxchfa>ABOUT</span> <span class="zh" data-astro-cid-37fxchfa>关于</span> </div> <div class="nav-desc" data-astro-cid-37fxchfa>
想快速了解我？<br data-astro-cid-37fxchfa>想知道更多？
</div> </a> </nav> </div> <!-- 页面内容 --> <main class="page-content" data-astro-cid-37fxchfa>  <div class="reader-container" data-astro-cid-7purwvht> <header class="reader-header" data-astro-cid-7purwvht> <a href="/archive/memoir" class="back-btn" data-astro-cid-7purwvht> <span class="icon" data-astro-cid-7purwvht>←</span> 返回
</a> <div class="reader-controls" data-astro-cid-7purwvht> <button id="toggle-mode" class="control-btn" data-astro-cid-7purwvht>切换滚动模式</button> <button id="prev-page" class="control-btn" disabled data-astro-cid-7purwvht>上一页</button> <span class="page-info" data-astro-cid-7purwvht> <input type="number" id="page-num-input" value="1" min="1" class="page-input" data-astro-cid-7purwvht> / <span id="page-count" data-astro-cid-7purwvht>--</span> </span> <button id="next-page" class="control-btn" data-astro-cid-7purwvht>下一页</button> <button id="zoom-out" class="control-btn icon-btn" data-astro-cid-7purwvht>−</button> <button id="zoom-in" class="control-btn icon-btn" data-astro-cid-7purwvht>+</button> </div> </header> <div class="pdf-viewer-wrapper" id="pdf-viewer-wrapper" data-astro-cid-7purwvht> <div id="pdf-container" data-astro-cid-7purwvht></div> </div> <div id="loading-indicator" class="loading-indicator" data-astro-cid-7purwvht>
加载中...
</div> </div>  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script> <script>
    // 设置 worker 路径
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const url = '/memoir.pdf'; // PDF 文件路径

    let pdfDoc = null,
        pageNum = 1,
        scale = 1.5,
        isScrollMode = false,
        renderedPages = new Set(),
        wrapper = document.getElementById('pdf-viewer-wrapper'),
        container = document.getElementById('pdf-container');

    // 移动端自适应初始缩放比例
    if (window.innerWidth < 768) {
      scale = window.innerWidth / 600;
    }

    // 创建页面容器
    const createPageContainer = async (num) => {
      const pageDiv = document.createElement('div');
      pageDiv.className = 'pdf-page';
      pageDiv.id = `page-${num}`;
      pageDiv.dataset.pageNumber = num;
      
      // 预先获取页面尺寸以设置占位符大小，防止滚动条跳动
      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale });
        pageDiv.style.width = `${viewport.width}px`;
        pageDiv.style.height = `${viewport.height}px`;
        pageDiv.style.minHeight = `${viewport.height}px`; // Ensure it takes up space even before canvas renders
        pageDiv.style.flexShrink = '0'; // Prevent flexbox from squishing the pages
      } catch (e) {
        console.error('Error getting page size for placeholder', e);
      }
      
      const canvas = document.createElement('canvas');
      const textLayer = document.createElement('div');
      textLayer.className = 'textLayer';
      const annotationLayer = document.createElement('div');
      annotationLayer.className = 'annotationLayer';

      pageDiv.appendChild(canvas);
      pageDiv.appendChild(textLayer);
      pageDiv.appendChild(annotationLayer);
      container.appendChild(pageDiv);
      
      return { pageDiv, canvas, textLayer, annotationLayer };
    };

    // 渲染单页
    const renderPage = async (num) => {
      if (renderedPages.has(num)) return;
      
      let pageElements = document.getElementById(`page-${num}`);
      let canvas, textLayer, annotationLayer;
      
      if (!pageElements) {
        const els = await createPageContainer(num);
        canvas = els.canvas;
        textLayer = els.textLayer;
        annotationLayer = els.annotationLayer;
      } else {
        canvas = pageElements.querySelector('canvas');
        textLayer = pageElements.querySelector('.textLayer');
        annotationLayer = pageElements.querySelector('.annotationLayer');
      }

      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale });
        
        // 设置尺寸
        pageElements = document.getElementById(`page-${num}`);
        pageElements.style.width = `${viewport.width}px`;
        pageElements.style.height = `${viewport.height}px`;
        
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        // 渲染 Canvas
        const renderCtx = {
          canvasContext: canvas.getContext('2d'),
          viewport: viewport
        };
        await page.render(renderCtx).promise;

        // 渲染文本层 (用于选中和搜索)
        textLayer.innerHTML = '';
        textLayer.style.width = `${viewport.width}px`;
        textLayer.style.height = `${viewport.height}px`;
        textLayer.style.setProperty('--scale-factor', scale);
        
        const textContent = await page.getTextContent();
        pdfjsViewer.renderTextLayer({
          textContentSource: textContent,
          container: textLayer,
          viewport: viewport,
          textDivs: []
        });

        // 渲染注释层 (用于超链接)
        annotationLayer.innerHTML = '';
        annotationLayer.style.width = `${viewport.width}px`;
        annotationLayer.style.height = `${viewport.height}px`;
        
        const annotations = await page.getAnnotations();
        
        // 手动渲染超链接，确保兼容性和可点击性
        annotations.forEach(annotation => {
          // PDF.js 中，外部链接通常在 annotation.url，内部跳转在 annotation.dest
          if (annotation.subtype === 'Link') {
            const a = document.createElement('a');
            a.className = 'pdf-link';
            
            if (annotation.url) {
              a.href = annotation.url;
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
            } else if (annotation.dest) {
              // 内部跳转 (暂不处理复杂跳转，仅阻止默认行为)
              a.href = '#';
              a.onclick = async (e) => {
                e.preventDefault();
                console.log('Internal link clicked:', annotation.dest);
                try {
                  // 尝试解析内部跳转目标
                  let dest = annotation.dest;
                  if (typeof dest === 'string') {
                    dest = await pdfDoc.getDestination(dest);
                  }
                  if (dest && dest[0]) {
                    const pageIndex = await pdfDoc.getPageIndex(dest[0]);
                    const targetPageNum = pageIndex + 1;
                    
                    if (isScrollMode) {
                      const targetEl = document.getElementById(`page-${targetPageNum}`);
                      if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth' });
                    } else {
                      pageNum = targetPageNum;
                      container.innerHTML = '';
                      renderedPages.clear();
                      renderPage(pageNum);
                      wrapper.scrollTop = 0;
                      document.getElementById('page-num-input').value = pageNum;
                      document.getElementById('prev-page').disabled = pageNum <= 1;
                      document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
                    }
                  }
                } catch (err) {
                  console.error('Error navigating to internal link:', err);
                }
              };
            } else {
              return; // 没有目标，跳过
            }
            
            // 将 PDF 坐标转换为视口坐标
            const rect = viewport.convertToViewportRectangle(annotation.rect);
            const x = Math.min(rect[0], rect[2]);
            const y = Math.min(rect[1], rect[3]);
            const width = Math.abs(rect[0] - rect[2]);
            const height = Math.abs(rect[1] - rect[3]);
            
            a.style.left = `${x}px`;
            a.style.top = `${y}px`;
            a.style.width = `${width}px`;
            a.style.height = `${height}px`;
            
            annotationLayer.appendChild(a);
          }
        });

        renderedPages.add(num);
        
        // 更新页码显示 (单页模式下)
        if (!isScrollMode) {
          document.getElementById('page-num-input').value = num;
          document.getElementById('prev-page').disabled = num <= 1;
          document.getElementById('next-page').disabled = num >= pdfDoc.numPages;
        }
      } catch (err) {
        console.error(`Error rendering page ${num}:`, err);
      }
    };

    // 切换模式
    const toggleMode = async () => {
      isScrollMode = !isScrollMode;
      const btn = document.getElementById('toggle-mode');
      btn.textContent = isScrollMode ? '切换单页模式' : '切换滚动模式';
      
      document.getElementById('prev-page').style.display = isScrollMode ? 'none' : 'block';
      document.getElementById('next-page').style.display = isScrollMode ? 'none' : 'block';
      
      container.innerHTML = '';
      renderedPages.clear();
      
      if (isScrollMode) {
        // 滚动模式：创建所有占位符，使用 IntersectionObserver 懒加载
        // 显示加载提示
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';
        loadingIndicator.textContent = '正在准备滚动模式...';
        
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          await createPageContainer(i);
        }
        
        loadingIndicator.style.display = 'none';
        setupIntersectionObserver();
        
        // 滚动到当前页
        setTimeout(() => {
          const currentPageEl = document.getElementById(`page-${pageNum}`);
          if (currentPageEl) {
            currentPageEl.scrollIntoView();
          }
        }, 100);
      } else {
        // 单页模式：只渲染当前页
        if (observer) observer.disconnect();
        renderPage(pageNum);
      }
    };

    // 懒加载观察者
    let observer;
    const setupIntersectionObserver = () => {
      if (observer) observer.disconnect();
      
      // 记录每个页面的可见度
      const pageVisibility = new Map();
      
      observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const num = parseInt(entry.target.dataset.pageNumber);
          
          // 更新该页面的可见度
          pageVisibility.set(num, entry.intersectionRatio);
          
          // 如果进入视口，触发渲染
          if (entry.isIntersecting) {
            renderPage(num);
          }
        });

        // 找到当前在视口中占比最大的页面
        let maxIntersectionRatio = 0;
        let visiblePageNum = pageNum;

        for (const [num, ratio] of pageVisibility.entries()) {
          if (ratio > maxIntersectionRatio) {
            maxIntersectionRatio = ratio;
            visiblePageNum = num;
          }
        }

        // 更新当前阅读页码
        if (maxIntersectionRatio > 0 && visiblePageNum !== pageNum) {
          pageNum = visiblePageNum;
          document.getElementById('page-num-input').value = pageNum;
          
          // 滚动模式下也更新按钮状态（虽然按钮可能被隐藏，但保持状态正确）
          document.getElementById('prev-page').disabled = pageNum <= 1;
          document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
        }
      }, {
        root: wrapper,
        rootMargin: '100% 0px', // 提前一屏加载
        threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0] // 增加更多阈值以更精确地判断哪个页面最可见
      });

      document.querySelectorAll('.pdf-page').forEach(page => {
        observer.observe(page);
      });
    };

    // 上一页
    const showPrevPage = () => {
      if (isScrollMode || pageNum <= 1) return;
      pageNum--;
      container.innerHTML = '';
      renderedPages.clear();
      renderPage(pageNum);
      wrapper.scrollTop = 0;
      
      // 更新按钮状态
      document.getElementById('page-num-input').value = pageNum;
      document.getElementById('prev-page').disabled = pageNum <= 1;
      document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
    };

    // 下一页
    const showNextPage = () => {
      if (isScrollMode || pageNum >= pdfDoc.numPages) return;
      pageNum++;
      container.innerHTML = '';
      renderedPages.clear();
      renderPage(pageNum);
      wrapper.scrollTop = 0;
      
      // 更新按钮状态
      document.getElementById('page-num-input').value = pageNum;
      document.getElementById('prev-page').disabled = pageNum <= 1;
      document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
    };

    // 重新渲染当前视图
    const reRender = () => {
      renderedPages.clear();
      if (isScrollMode) {
        document.querySelectorAll('.pdf-page').forEach(page => {
          const canvas = page.querySelector('canvas');
          if (canvas) {
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
          }
        });
        // 触发 observer 重新渲染可见区域
        wrapper.dispatchEvent(new Event('scroll'));
      } else {
        container.innerHTML = '';
        renderPage(pageNum);
      }
    };

    // 放大
    const zoomIn = () => {
      scale += 0.2;
      reRender();
    };

    // 缩小
    const zoomOut = () => {
      if (scale <= 0.4) return;
      scale -= 0.2;
      reRender();
    };

    // 获取文档
    pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
      pdfDoc = pdfDoc_;
      document.getElementById('page-count').textContent = pdfDoc.numPages;
      document.getElementById('loading-indicator').style.display = 'none';
      
      // 默认单页模式
      renderPage(pageNum);
    }).catch(err => {
      const loadingIndicator = document.getElementById('loading-indicator');
      loadingIndicator.textContent = '加载 PDF 失败，请检查文件是否存在。';
      loadingIndicator.style.color = '#f87171';
      console.error('Error loading PDF:', err);
    });

    // 绑定事件
    document.getElementById('prev-page').addEventListener('click', showPrevPage);
    document.getElementById('next-page').addEventListener('click', showNextPage);
    document.getElementById('zoom-in').addEventListener('click', zoomIn);
    document.getElementById('zoom-out').addEventListener('click', zoomOut);
    document.getElementById('toggle-mode').addEventListener('click', toggleMode);

    // 页码输入跳转
    const pageInput = document.getElementById('page-num-input');
    
    const handlePageJump = () => {
      let targetPage = parseInt(pageInput.value);
      
      // 验证输入
      if (isNaN(targetPage) || targetPage < 1) {
        targetPage = 1;
      } else if (targetPage > pdfDoc.numPages) {
        targetPage = pdfDoc.numPages;
      }
      
      // 更新输入框显示为有效值
      pageInput.value = targetPage;
      
      if (targetPage === pageNum && !isScrollMode) return;
      
      pageNum = targetPage;
      
      if (isScrollMode) {
        // 滚动模式下，滚动到对应页面
        const targetPageEl = document.getElementById(`page-${pageNum}`);
        if (targetPageEl) {
          targetPageEl.scrollIntoView({ behavior: 'smooth' });
        } else {
          // 如果页面元素还不存在（可能在很后面），先渲染它
          container.innerHTML = '';
          renderedPages.clear();
          for (let i = 1; i <= pdfDoc.numPages; i++) {
            createPageContainer(i);
          }
          setupIntersectionObserver();
          setTimeout(() => {
            const newTargetEl = document.getElementById(`page-${pageNum}`);
            if (newTargetEl) newTargetEl.scrollIntoView({ behavior: 'smooth' });
          }, 100);
        }
        
        // 更新按钮状态
        document.getElementById('prev-page').disabled = pageNum <= 1;
        document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
      } else {
        // 单页模式下，重新渲染
        container.innerHTML = '';
        renderedPages.clear();
        renderPage(pageNum);
        
        // 更新按钮状态
        document.getElementById('prev-page').disabled = pageNum <= 1;
        document.getElementById('next-page').disabled = pageNum >= pdfDoc.numPages;
      }
    };

    pageInput.addEventListener('change', handlePageJump);
    pageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        handlePageJump();
        pageInput.blur(); // 移除焦点，隐藏移动端键盘
      }
    });

    // 键盘翻页支持
    document.addEventListener('keydown', (e) => {
      // 如果焦点在输入框内，不触发左右键翻页
      if (document.activeElement === pageInput) return;
      
      if (isScrollMode) return;
      if (e.key === 'ArrowLeft') showPrevPage();
      if (e.key === 'ArrowRight') showNextPage();
    });
  </script>  </main> <script type="module">document.documentElement.scrollTop=0;document.body.scrollTop=0;window.scrollTo(0,0);window.addEventListener("load",()=>{document.documentElement.scrollTop=0,document.body.scrollTop=0,window.scrollTo(0,0)});</script> </body> </html>  